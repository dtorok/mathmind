<!DOCTYPE HTML>
<html><head><meta charset="UTF-8"><title>Main</title><head>
<body>
<div id="spelling"></div>

<script src="config.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: API_KEY,
    authDomain: "mathmind-58910.firebaseapp.com",
    databaseURL: "https://mathmind-58910.firebaseio.com",
    projectId: "mathmind-58910",
    storageBucket: "mathmind-58910.appspot.com",
    messagingSenderId: "132308405522"
  };
  firebase.initializeApp(config);

  var database = firebase.database();
  var keyBase = "mathmind/"
  var KeyBaseImagesDone = keyBase + "images-done/"
  var keyBaseExercisesSolved = keyBase + "exercises-solved/"
</script>

<script src="resources/exercise-puzzle.js"></script>
<script>
    var app = Elm.ExercisePuzzle.fullscreen();

    app.ports.setImageDone.subscribe(function(msg) {
      var parts = msg.split("/:/")
      var imageId = parts[0];
      var score = Number.parseInt(parts[1]);

      database.ref(KeyBaseImagesDone + imageId).set({
        done: true,
        score: score
      }).then(getDoneImages);
    });

    app.ports.exerciseSolved.subscribe(function(msg) {
      var exerciseType = msg;
      var key = keyBaseExercisesSolved + msg + "/";
      console.log("exerciseSolved: " + exerciseType);
      database
        .ref(key)
        .once('value', function(data) {
          var val = data.val();
          console.log("currentScore for " + exerciseType + ": " + val);
          database.ref(key).set(val + 1)
        })
        .then(showScore)
    });

    app.ports.getDoneImages.subscribe(function() {
      getDoneImages()
    });

    function getDoneImages() {
      database.ref(KeyBaseImagesDone).once('value', function(data) {
        var doneImages = [];
        data.forEach(function(item) {
          doneImages.push(item.key)
        })

        console.log("images are done: " + doneImages)
        app.ports.doneImages.send(doneImages);
      });
    }

    function showScore() {
      console.log("show score")
    }

</script>
</body>
</html>